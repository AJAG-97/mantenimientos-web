<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Mantenimientos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .live-indicator {
            display: inline-block;
            padding: 5px 15px;
            background: #4CAF50;
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
            animation: pulse 2s infinite;
        }

        .live-indicator.offline {
            background: #ff9800;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .setup-banner {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .setup-banner.show {
            display: block;
        }

        .setup-banner h3 {
            color: #1976D2;
            margin-bottom: 15px;
        }

        .setup-banner p, .setup-banner li {
            color: #424242;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .setup-banner ol {
            margin-left: 20px;
        }

        .setup-banner input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #2196F3;
            border-radius: 5px;
        }

        .setup-banner button {
            background: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
        }

        .setup-banner button:hover {
            background: #1976D2;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .photo-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .photo-upload {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-upload:hover {
            background: #f5f7ff;
            border-color: #764ba2;
        }

        .photo-upload input {
            display: none;
        }

        .photo-preview {
            margin-top: 15px;
            max-width: 100%;
            border-radius: 8px;
        }

        .photo-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .maintenance-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .maintenance-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
        }

        .card-date {
            color: #666;
            font-size: 0.95em;
        }

        .card-info {
            margin-bottom: 10px;
        }

        .card-label {
            font-weight: 600;
            color: #555;
            margin-right: 5px;
        }

        .card-photos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .card-photo {
            text-align: center;
        }

        .card-photo img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .card-photo p {
            margin-top: 8px;
            font-weight: 600;
            color: #667eea;
        }

        .btn-download {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            display: inline-block;
            margin-right: 10px;
        }

        .btn-delete {
            background: #f44336;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .code-box {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
            word-break: break-all;
        }

        @media (max-width: 768px) {
            .photo-section {
                grid-template-columns: 1fr;
            }
            
            .card-photos {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Sistema de Mantenimientos</h1>
            <p class="subtitle">Registro y seguimiento de mantenimientos en tiempo real</p>
            <div class="live-indicator" id="liveIndicator">‚ö´ Configuraci√≥n pendiente</div>
        </div>

        <div class="setup-banner show" id="setupBanner">
            <h3>üî• Firebase - Configuraci√≥n R√°pida (5 minutos)</h3>
            <ol>
                <li>Ve a <a href="https://console.firebase.google.com" target="_blank"><strong>Firebase Console</strong></a></li>
                <li>Crea un nuevo proyecto (dale el nombre que quieras)</li>
                <li>En el men√∫ lateral, ve a <strong>Firestore Database</strong> ‚Üí Crear base de datos</li>
                <li>Selecciona <strong>"Modo de prueba"</strong> ‚Üí Siguiente ‚Üí Habilitar</li>
                <li>Ve a <strong>Configuraci√≥n del proyecto</strong> (√≠cono de engranaje) ‚Üí Agregar app ‚Üí Web</li>
                <li>Copia la configuraci√≥n que aparece y p√©gala abajo:</li>
            </ol>
            
            <label>Configuraci√≥n de Firebase (formato JSON):</label>
  <textarea id="firebaseConfig" rows="8">
{
  "apiKey": "AIzaSyBN5BdJX6FYA98_E6FSHI22MkwDpiqKBlw",
  "authDomain": "mantenimientos-780be.firebaseapp.com",
  "projectId": "mantenimientos-780be",
  "storageBucket": "mantenimientos-780be.firebasestorage.app",
  "messagingSenderId": "779033066908",
  "appId": "1:779033066908:web:5bf1c2badbdbed0e199c59"
}
</textarea>

            <button id="btnSaveFirebase">üöÄ Activar Sincronizaci√≥n en Tiempo Real</button>

        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('nuevo')">‚ûï Nuevo Registro</button>
            <button class="tab" onclick="switchTab('historial')">üìã Historial</button>
            <button class="tab" onclick="switchTab('config')">‚öôÔ∏è Configuraci√≥n</button>
        </div>

        <div class="content">
            <!-- Tab Nuevo Registro -->
            <div id="nuevo" class="tab-content active">
                <form id="maintenanceForm">
                    <div class="form-group">
                        <label for="equipmentName">Nombre del Equipo/√Årea *</label>
                        <input type="text" id="equipmentName" required placeholder="Ej: Compresor Principal">
                    </div>

                    <div class="form-group">
                        <label for="maintenanceType">Tipo de Mantenimiento *</label>
                        <select id="maintenanceType" required>
                            <option value="">Seleccionar...</option>
                            <option value="preventivo">Preventivo</option>
                            <option value="correctivo">Correctivo</option>
                            <option value="predictivo">Predictivo</option>
                            <option value="limpieza">Limpieza</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="date">Fecha *</label>
                        <input type="date" id="date" required>
                    </div>

                    <div class="form-group">
                        <label for="time">Hora *</label>
                        <input type="time" id="time" required>
                    </div>

                    <div class="form-group">
                        <label for="technician">T√©cnico Responsable *</label>
                        <input type="text" id="technician" required placeholder="Nombre del t√©cnico">
                    </div>

                    <div class="form-group">
                        <label for="description">Descripci√≥n del Trabajo Realizado *</label>
                        <textarea id="description" required placeholder="Detalle las actividades realizadas..."></textarea>
                    </div>

                    <div class="photo-section">
                        <div>
                            <label>Foto ANTES</label>
                            <div class="photo-upload" onclick="document.getElementById('photoBefore').click()">
                                <input type="file" id="photoBefore" accept="image/*">
                                <p>üì∑ Click para subir foto</p>
                                <div id="previewBefore" class="photo-preview"></div>
                            </div>
                        </div>
                        <div>
                            <label>Foto DESPU√âS</label>
                            <div class="photo-upload" onclick="document.getElementById('photoAfter').click()">
                                <input type="file" id="photoAfter" accept="image/*">
                                <p>üì∑ Click para subir foto</p>
                                <div id="previewAfter" class="photo-preview"></div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">üíæ Guardar Registro</button>
                </form>
            </div>

            <!-- Tab Historial -->
            <div id="historial" class="tab-content">
                <div class="stats" id="stats"></div>
                <div id="maintenanceList"></div>
            </div>

            <!-- Tab Configuraci√≥n -->
            <div id="config" class="tab-content">
                <h2 style="margin-bottom: 20px;">‚öôÔ∏è Configuraci√≥n de Firebase</h2>
                <div class="form-group">
                    <label>Configuraci√≥n de Firebase (JSON):</label>
                    <textarea id="firebaseConfigEdit" rows="8"></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveFirebaseConfig()">üíæ Guardar Configuraci√≥n</button>
                
                <hr style="margin: 30px 0;">
                
                <h3>üìù Instrucciones Detalladas:</h3>
                <ol style="line-height: 2; margin-top: 15px;">
                    <li>Ve a <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                    <li>Click en "Crear un proyecto" o "Agregar proyecto"</li>
                    <li>Dale un nombre (ej: "mantenimientos-2025")</li>
                    <li>Desactiva Google Analytics (opcional) y crea el proyecto</li>
                    <li>En el men√∫ lateral: <strong>Compilaci√≥n</strong> ‚Üí <strong>Firestore Database</strong></li>
                    <li>Click en "Crear base de datos"</li>
                    <li>Selecciona <strong>"Comenzar en modo de prueba"</strong> ‚Üí Siguiente</li>
                    <li>Selecciona una ubicaci√≥n cercana ‚Üí Habilitar</li>
                    <li>Ve al √≠cono de engranaje ‚öôÔ∏è ‚Üí "Configuraci√≥n del proyecto"</li>
                    <li>En "Tus apps" ‚Üí Click en el √≠cono </> (Web)</li>
                    <li>Dale un nombre y registra la app</li>
                    <li>Copia todo el objeto firebaseConfig que aparece</li>
                    <li>P√©galo arriba y guarda</li>
                </ol>
            </div>
        </div>
    </div>

   
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

let db = null;
let storage = null;
let maintenances = [];
let unsubscribe = null;

/* =========================
   FIREBASE INIT
========================= */
function initFirebase(config) {
    const app = initializeApp(config);
    db = getFirestore(app);
    storage = getStorage(app);
    updateStatus(true);
    listenToChanges();
}

/* =========================
   SAVE CONFIG (UNA SOLA VEZ)
========================= */
window.saveFirebaseConfig = function () {
    const textarea =
        document.getElementById('firebaseConfig') ||
        document.getElementById('firebaseConfigEdit');

    if (!textarea.value.trim()) {
        alert('‚ùå Pega la configuraci√≥n de Firebase');
        return;
    }

    try {
        const config = JSON.parse(textarea.value);
        localStorage.setItem('firebaseConfig', textarea.value);
        initFirebase(config);
        document.getElementById('setupBanner')?.classList.remove('show');
        alert('‚úÖ Firebase conectado correctamente');
    } catch (e) {
        console.error(e);
        alert('‚ùå JSON inv√°lido');
    }
};

document.getElementById('btnSaveFirebase')
?.addEventListener('click', window.saveFirebaseConfig);

/* =========================
   REALTIME LISTENER
========================= */
function listenToChanges() {
    const q = query(collection(db, 'maintenances'), orderBy('timestamp', 'desc'));
    unsubscribe = onSnapshot(q, snap => {
        maintenances = [];
        snap.forEach(d => maintenances.push({ id: d.id, ...d.data() }));
        displayMaintenances();
    });
}

/* =========================
   FORM SUBMIT (FIX REAL)
========================= */
document.getElementById('maintenanceForm')
.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!db || !storage) {
        alert('‚ö†Ô∏è Configura Firebase primero');
        return;
    }

    try {
        const photoBefore = document.getElementById('photoBefore').files[0];
        const photoAfter = document.getElementById('photoAfter').files[0];

        const beforeURL = photoBefore ? await uploadPhoto(photoBefore, 'before') : null;
        const afterURL  = photoAfter  ? await uploadPhoto(photoAfter, 'after')  : null;

        await addDoc(collection(db, 'maintenances'), {
            equipmentName: equipmentName.value,
            maintenanceType: maintenanceType.value,
            date: date.value,
            time: time.value,
            technician: technician.value,
            description: description.value,
            photoBefore: beforeURL,
            photoAfter: afterURL,
            timestamp: new Date().toISOString()
        });

        alert('‚úÖ Registro guardado');
        e.target.reset();
        previewBefore.innerHTML = '';
        previewAfter.innerHTML = '';
        switchTab('historial');
    } catch (err) {
        console.error(err);
        alert('‚ùå Error al guardar');
    }
});

/* =========================
   STORAGE
========================= */
async function uploadPhoto(file, folder) {
    const fileRef = ref(storage, `${folder}/${Date.now()}_${file.name}`);
    await uploadBytes(fileRef, file);
    return await getDownloadURL(fileRef);
}

/* =========================
   UI
========================= */
function updateStatus(ok) {
    const i = document.getElementById('liveIndicator');
    i.textContent = ok ? 'üî¥ EN VIVO - Firebase' : '‚ö´ OFFLINE';
    i.classList.toggle('offline', !ok);
}

window.switchTab = function(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
};

/* =========================
   LOAD SAVED CONFIG
========================= */
window.addEventListener('load', () => {
    const cfg = localStorage.getItem('firebaseConfig');
    if (cfg) {
        document.getElementById('firebaseConfigEdit').value = cfg;
        initFirebase(JSON.parse(cfg));
        setupBanner.classList.remove('show');
    }
});
</script>









